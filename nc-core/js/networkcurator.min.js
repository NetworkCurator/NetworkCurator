/* 
 * nc-core.js
 *  
 * 
 * 
 *//**
 * nc is the main object/namespace for the NetworkCurator
 * 
 * The nc namespace holds data relevant to the current user and the current page.
 * 
 * Sub-namespaces hold functions relevant for manipulating objects, dealing
 * with the user interface, or communicating with the server.
 *   
 */var nc={userid:"",firstname:"",middlename:"",lastname:"",network:"",networktitle:"",md:{},comments:{},commentator:0,curator:0,editor:0,api:window.location.href.split("?")[0]+"nc-core/networkcurator.php",admin:{},classes:{},graph:{},init:{},permissions:{},users:{},ui:{},utils:{}};nc.msg=function(e,t){$("#nc-msg-header").html(e),$("#nc-msg-body").html(t),$("#nc-msg-modal").modal("show")},nc.init.all=function(){var e=nc.ui.speed;nc.ui.speed=0,nc.init.initNetwork(),nc.init.initPermissions(),nc.init.initLog(),nc.init.initCuration(),nc.init.initMarkdown(),nc.init.initComments(),nc.init.initOntology(),nc.init.initGraph(),nc.ui.speed=e},nc.init.initPermissions=function(){var e=$("#nc-permissions-guest"),t=$("#nc-permissions-users");if(e.length==0||t.length==0)return;e.append(nc.ui.PermissionsWidget(nc.permissions.guest)),t.append(nc.ui.PermissionsWidget(nc.permissions.users)),$(".btn-group .disabled").click(function(e){e.stopPropagation()})},nc.init.initOntology=function(){nc.ontology.nodes=nc.ontology.addLongnames(nc.ontology.nodes),nc.ontology.links=nc.ontology.addLongnames(nc.ontology.links);var e=$("#nc-ontology-nodes"),t=$("#nc-ontology-links");if(e.length==0||t.length==0)return;e.html(nc.ui.ClassTreeWidget(nc.ontology.nodes,!1)),t.html(nc.ui.ClassTreeWidget(nc.ontology.links,!0))},nc.init.initLog=function(){var e=$("#nc-activity-log");if(e.length==0)return;$.post(nc.api,{controller:"NCNetworks",action:"getActivityLogSize",network:nc.network},function(t){t=JSON.parse(t);var n=+t.data;e.append(nc.ui.ActivityLogToolbar(n,50)),nc.loadActivity(0,50)})},nc.init.initGraph=function(){if($("#nc-graph-svg").length==0)return;nc.graph.initToolbar(),nc.graph.initSimulation(),nc.graph.simUnpause()},nc.init.initComments=function(){var e=$("#nc-comments");if(e.length==0)return;$.post(nc.api,{controller:"NCAnnotations",action:"getComments",network:nc.network,root_id:e.attr("val")},function(e){e=JSON.parse(e);if(!e.success){nc.msg("Hey!","Got error response from server: "+e.data);return}nc.ui.populateCommentsBox(e.data)});if(!nc.commentator)return;var t=$("#nc-newcomment").attr("val");$("#nc-newcomment").html(nc.ui.CommentBox(nc.userid,t,t,"",""))},nc.init.initCuration=function(){var e=nc.ui.AnnoEditBox(),t=$(".nc-editable-text");t.html(e),$(".nc-curator").show();var n=$("#nc-curation-lock");n.on("click",function(){n.find("span.glyphicon-pencil, span.glyphicon-lock").toggleClass("glyphicon-pencil glyphicon-lock"),n.toggleClass("nc-editing nc-looking");var e=nc.curator?$(".nc-editable-text"):$('.nc-editable-text[owner="'+nc.userid+'"]');e.toggleClass("nc-editable-text-visible")}),$(".nc-curation-toolbox").css("font-size",$("body").css("font-size"))},nc.init.initMarkdown=function(){$.each(nc.md,function(e,t){var n=$('.nc-md[val="'+e+'"]'),r=n.find("textarea.nc-curation-content"),i=nc.utils.md2html(t);r.length>0?(n.find("textarea.nc-curation-content").html(t),n.find("div.nc-curation-content").html(i)):n.html(i)})},nc.init.initNetwork=function(){nc.networktitle!=""&&($("#nc-nav-network-title").html(nc.networktitle),$("body").addClass("nc-body2")),nc.curator||$(".nc-curator").hide(),nc.editor||$(".nc-editor").hide(),nc.commentator||$(".nc-commentator").hide()},nc.loadActivity=function(e,t){$("#nc-activity-log li[value!="+e+"]").removeClass("active"),$("#nc-activity-log li[value="+e+"]").addClass("active"),$.post(nc.api,{controller:"NCNetworks",action:"getNetworkActivity",network:nc.network,offset:e*t,limit:t},function(e){e=JSON.parse(e),e.success?nc.ui.populateActivityArea(e.data):nc.msg(e.data)})},nc.updateAnnotationText=function(e,t){if(nc.network=="")return;if(t==""){nc.msg("Hey","Annotation text cannot be blank");return}$.post(nc.api,{controller:"NCAnnotations",action:"updateAnnotationText",network:nc.network,anno_id:e,anno_text:t},function(e){nc.utils.alert(e),e=JSON.parse(e),e.success||nc.msg("Hey!","Got error response from server: "+e.data)})},nc.createComment=function(e,t,n){if(nc.network=="")return;if(e.length<2)return;$("#nc-newcomment a.nc-submit").removeClass("btn-success").addClass("btn-default").html("Sending..."),$.post(nc.api,{controller:"NCAnnotations",action:"createNewComment",network:nc.network,root_id:t,parent_id:n,anno_text:e},function(r){nc.utils.alert(r),r=JSON.parse(r);if(!r.success){nc.msg("Hey!","Got error response from server: "+r.data);return}$("#nc-newcomment a.nc-submit").html("Done"),setTimeout(function(){$("#nc-newcomment a.nc-submit").addClass("btn-success").removeClass("btn-default").html("Submit")},this.timeout);var i={datetime:"just now",modified:null,user_id:nc.userid,owner_id:nc.userid,root_id:t,parent_id:n,anno_id:r.data,anno_text:e};nc.ui.addCommentBox(i),t!=n&&$('.media-body .media[val=""]').hide(),$("#nc-newcomment textarea").val("")})},$(document).ready(function(){nc.init.all()});if(typeof nc=="undefined")throw new Error("nc is undefined");nc.utils={},nc.utils.debug=!1,nc.utils.alert=function(e){nc.utils.debug&&alert(e)},nc.utils.checkString=function(e,t){var n="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";t==1?n+="_-":t==2?n+=" '-":t==3&&(n+="_-$-.+!*'(),");if(t==1&&e[0]=="_")return 0;var r=e.length;if(t>=0){if(r<2)return 0;if(t==3&&r<7)return 0}for(var i=0;i<r;i++)if(n.indexOf(e[i])<0)return 0;return 1},nc.utils.checkFormInput=function(e,t,n){var r="#"+e+" input,#"+e+" textarea";return nc.utils.checkString($(r).val(),n)==0?($("#"+e).addClass("has-warning"),$("#"+e+" label").html("Please enter a (valid) "+t+":"),0):1},nc.utils.checkFormEmail=function(e){var t=$("#"+e+" input").val(),n=t.indexOf("@");return n==-1||t.indexOf(".",n)<2?($("#"+e).addClass("has-warning"),$("#"+e+" label").html("Please enter a (valid) email:"),0):1},nc.utils.checkAPIresult=function(e){return"success"in e&&("data"in e||"errormsg"in e)?!0:(nc.utils.alert("Something wrong in API result: "+JSON.stringify(e)),!1)},nc.utils.sortByKey=function(e,t){return e.sort(function(e,n){var r=e[t],i=n[t];return r<i?-1:r>i?1:0})},nc.utils.mdconverter=new showdown.Converter({headerLevelStart:1,tables:!0,strikethrough:!0,tasklists:!0}),nc.utils.allowedTags=["h3","h4","h5","h6","blockquote","p","a","ul","ol","nl","li","b","i","strong","em","strike","code","hr","br","div","table","thead","caption","tbody","tr","th","td","pre","circle","rect","line","path","polyline","ellipse","polygon","marker"],nc.utils.allowedAttributes={code:["class"],style:["type"],circle:["cx","cy","r","id","fill"],rect:["x","y","width","height","id","fill"],marker:["id","viewbox","refX","refY","markerWidth","markerHeight","orient"],line:["x1","x2","y1","y2","id"],path:["d","fill"]},nc.utils.md2html=function(e){var t=nc.utils.sanitize(nc.utils.mdconverter.makeHtml(e),!1);return mdalive.makeAlive(t)},nc.utils.sanitize=function(e,t){var n=nc.utils.allowedTags.slice(0);return t&&n.push("style"),sanitizeHtml(e,{allowedTags:n,allowedAttributes:nc.utils.allowedAttributes})},$.fn.xml=function(){return(new XMLSerializer).serializeToString(this[0])},$.fn.DOMRefresh=function(){return $($(this.xml()).replaceAll(this))};if(typeof nc=="undefined")throw new Error("nc is undefined");nc.admin={},nc.admin.createNetwork=function(e,t,n){$("#"+e+",#"+t+",#"+n).removeClass("has-warning has-error");if(nc.utils.checkFormInput(e,"network name",1)+nc.utils.checkFormInput(t,"network title",2)<2)return 0;var r=$("#"+n+" textarea").val();return r.length>250?0:($.post(nc.api,{controller:"NCNetworks",action:"createNewNetwork",network_name:$("#"+e+" input").val(),network_title:$("#"+t+" input").val(),network_desc:r},function(r){nc.utils.alert(r),r=JSON.parse(r),nc.utils.checkAPIresult(r)&&(r["success"]==0||r["data"]==0?($("#"+e).addClass("has-error has-feedback"),$("#"+e+" label").html("Please choose another network name:")):r["success"]==1&&r["data"]==1&&($("#"+e+",#"+t+",#"+n).addClass("has-success has-feedback"),$("form button.submit").removeClass("btn-success").addClass("btn-default disabled").html("Success!"),$("form,form button.submit").attr("disabled",!0)))}),1)},nc.admin.createUser=function(e,t,n,r,i,s,o){return $("form .form-group").removeClass("has-warning has-error"),nc.utils.checkFormInput(e,"first name",1)+nc.utils.checkFormInput(t,"middle name",-1)+nc.utils.checkFormInput(n,"last name",1)+nc.utils.checkFormInput(r,"user id",1)+nc.utils.checkFormInput(s,"password",1)+nc.utils.checkFormInput(o,"password",1)+nc.utils.checkFormEmail(i,"email")<7?0:$("#"+s+" input").val()!=$("#"+o+" input").val()?($("#"+o).addClass("has-warning"),$("#"+o+" label").html("Please re-confirm the password:"),0):($.post(nc.api,{controller:"NCUsers",action:"createNewUser",target_firstname:$("#"+e+" input").val(),target_middlename:$("#"+t+" input").val(),target_lastname:$("#"+n+" input").val(),target_email:$("#"+i+" input").val(),target_id:$("#"+r+" input").val(),target_password:$("#"+s+" input").val()},function(e){nc.utils.alert(e),e=JSON.parse(e),nc.utils.checkAPIresult(e)&&(e["success"]==0||e["data"]==0?($("#"+r).addClass("has-error has-feedback"),$("#"+r+" label").html("Please choose another user id:")):e["success"]==1&&e["data"]==1&&($("form .form-group").addClass("has-success has-feedback"),$("form button.submit").removeClass("btn-success").addClass("btn-default disabled").html("Success!"),$("form,form button.submit").attr("disabled",!0)))}),1)};if(typeof nc=="undefined")throw new Error("nc is undefined");nc.data={},nc.data.importData=function(e,t){$("#"+e+",#"+t).removeClass("has-warning has-error");if(nc.utils.checkFormInput(t,"description",2)<1)return 0;var n=$("#"+t+" input").val();if(n.length>128)return 0;var r=$("#"+e+" input"),i=r.val();i==""&&($("#"+e).addClass("has-warning"),$("#"+e+" label").html("Please select a data file"));var s=r[0].files[0],o=$("#nc-data-modal");return o.find("#nc-dataconfirm-file").html(i),o.find('button[val="nc-confirm"]').off("click").click(function(){nc.data.sendData(i,n,s)}),o.find('p[val="download"]').hide(),o.find('p[val="upload"]').show(),o.modal("show"),!1},nc.data.sendData=function(e,t,n){var r=$('#nc-import-form button[type="submit"]');r.toggleClass("btn-success btn-default disabled").html("Uploading");var i=new FileReader;i.onload=function(n){try{var s=JSON.stringify(JSON.parse(i.result))}catch(o){nc.msg("Error","File contents does not appear to be valid JSON");return}$.post(nc.api,{controller:"NCData",action:"importData",network:nc.network,file_name:e,file_desc:t,file_content:s},function(e){nc.utils.alert(e),e=JSON.parse(e),nc.utils.checkAPIresult(e)?e["success"]==0?$("#nc-import-response").html("Error: "+e.errormsg):$("#nc-import-response").html(e.data.replace(/\n/g,"<br/>")):$("#nc-import-response").html("something went wrong..."),r.toggleClass("btn-default disabled btn-success").html("Submit")})},i.readAsText(n)};if(typeof nc=="undefined")throw new Error("nc is undefined");nc.graph={rawnodes:[],rawlinks:[],nodes:[],links:[],info:{},sim:{},svg:{},mode:"select"},nc.graph.initToolbar=function(){var e=$("#nc-graph-toolbar");nc.graph.svg=d3.select("#nc-graph-svg");var t=function(e){var t=[];return $.each(e,function(e,n){t.push({id:n.class_id,label:n.longname,val:n.name,status:n.status})}),nc.utils.sortByKey(t,"label")},n=t(nc.ontology.nodes),r=t(nc.ontology.links);$("#nc-graph-newnode #fg-nodeclass .input-group-btn").append(nc.ui.DropdownButton("",n,"node",!1).find(".btn-group")),$("#nc-graph-newlink #fg-linkclass .input-group-btn").append(nc.ui.DropdownButton("",r,"link",!1).find(".btn-group")),e.append(nc.ui.ButtonGroup(["Select"])),e.append(nc.ui.DropdownButton("New node:",n,"node",!1)),e.append(nc.ui.DropdownButton("New link:",r,"link",!1)),e.find("button").click(function(){e.find("button").removeClass("active")});var i=$("#nc-graph-svg");i.mouseenter(function(){var e=$('#nc-graph-toolbar button[val="node"]'),t=$('#nc-graph-toolbar button[val="link"]');e.hasClass("active")?(i.css("cursor","crosshair"),nc.graph.svg.on("click",nc.graph.addNode),nc.graph.mode="newnode"):t.hasClass("active")?(i.css("cursor","crosshair"),nc.graph.svg.on("click",nc.graph.addLink),nc.graph.mode="newlink"):(i.css("cursor","grab"),nc.graph.svg.selectAll("g").attr("cursor","default"),nc.graph.svg.on("click",null),nc.graph.mode="select")})},nc.graph.addNode=function(){var e=d3.select('#nc-graph-toolbar button[val="node"]'),t=e.attr("class_id"),n=e.attr("class_name"),r=nc.graph.addClassedNode(nc.graph.getCoord(d3.mouse(this)),t,n,"nc-newnode");return nc.graph.select(r),r},nc.graph.addClassedNode=function(e,t,n,r){var i="+"+n+"_"+Date.now(),s={id:i,name:i,class_id:t,class_name:n,"class":r,status:1,x:e[0],y:e[1],fx:e[0],fy:e[1]};return nc.graph.simStop(),nc.graph.rawnodes.push(s),nc.graph.initSimulation(),s},nc.graph.addLink=function(){var e=d3.select('#nc-graph-toolbar button[val="link"]'),t=e.attr("class_id"),n=e.attr("class_name"),r=nc.graph.addClassedLink(t,n,"nc-newlink");return nc.graph.select(r),r},nc.graph.addClassedLink=function(e,t,n){var r=nc.graph.svg.select('line[class="nc-draggedlink"]');if(r.attr("source")===null||r.attr("target")===null)return null;var i="+"+t+"_"+Date.now(),s={id:i,class_id:e,class_name:t,status:1,"class":n,source:r.attr("source"),target:r.attr("target")};return nc.graph.simStop(),nc.graph.rawlinks.push(s),nc.graph.initSimulation(),s},nc.graph.select=function(e){if(e==null)return;nc.graph.unselect(),"source"in e?nc.graph.svg.select('line[id="'+e.id+'"]').classed("nc-link-highlight",!0):nc.graph.svg.select('use[id="'+e.id+'"]').classed("nc-node-highlight",!0);var t=e.id;if(t[0]=="+"){$("#nc-graph-details").hide(),nc.graph.resetForms();if("source"in e){var n=$("#nc-graph-newlink");$("#nc-graph-newlink #fg-linkname input").val(t),$("#nc-graph-newlink #fg-linktitle input").val(t),$("#nc-graph-newlink form").attr("val",t),n.find("button.dropdown-toggle span.nc-classname-span").html(e.class_name),n.find("button.dropdown-toggle").attr("selection",e.class_name),$("#nc-graph-newlink #fg-linksource input").val(e.source.name),$("#nc-graph-newlink #fg-linktarget input").val(e.target.name),n.show()}else{var r=$("#nc-graph-newnode");$("#nc-graph-newnode #fg-nodename input").val(t),$("#nc-graph-newnode #fg-nodetitle input").val(t),$("#nc-graph-newnode form").attr("val",t),r.find("button.dropdown-toggle span.nc-classname-span").html(e.class_name),r.find("button.dropdown-toggle").attr("selection",e.class_name),r.show()}}else nc.graph.displayInfo(e)},nc.graph.unselect=function(e){nc.graph.svg.selectAll("use").classed("nc-node-highlight",!1),nc.graph.svg.selectAll("line").classed("nc-link-highlight",!1),$("#nc-graph-newnode,#nc-graph-newlink,#nc-graph-details").hide()},nc.graph.displayInfo=function(e){if(e.id==null)return;var t="nc-graph-details",n=$("#"+t);n.find(".nc-md").html("Loading..."),n.find("#"+t+"-more").click(function(){var t="source"in e?"link":"node";window.location.replace("?network="+nc.network+"&object="+e.id)}),n.show();if(!(e.id in nc.graph.info)){nc.graph.getInfo(e);return}var r=nc.graph.info[e.id].title,i=nc.graph.info[e.id]["abstract"],s=nc.utils.md2html(r.anno_text);n.find("#"+t+"-title").html(s).attr("val",r.anno_id);var o=nc.utils.md2html(i.anno_text);n.find("#"+t+"-abstract").html(o).attr("val",i.anno_id),n.find("#"+t+"-class").html(e["class"])},nc.graph.getInfo=function(e){$.post(nc.api,{controller:"NCAnnotations",action:"getSummary",network:nc.network,root_id:e.id,name:1,title:1,"abstract":1,content:0},function(t){nc.utils.alert(t),t=JSON.parse(t),nc.utils.checkAPIresult(t)?nc.graph.info[e.id]=t.data:nc.graph.info[e.id]={title:"NA","abstract":"NA"},nc.graph.select(e)})},nc.graph.filterNodes=function(){var e=nc.graph.rawnodes,t=nc.ontology.nodes,n=e.length,r=0;nc.graph.nodes=[];for(var i=0;i<n;i++){var s=e[i].class_id;t[s].status>0&&(nc.graph.nodes[r]=e[i],r++)}},nc.graph.filterLinks=function(){var e=nc.graph.rawlinks,t=e.length,n=nc.ontology.links,r={};for(var i=0;i<nc.graph.nodes.length;i++)r[nc.graph.nodes[i].id]=1;var s=0;nc.graph.links=[];for(var o=0;o<t;o++){var u=e[o].class_id;if(n[u].status>0){var a=e[o].source,f=e[o].target;(a in r||a.id in r)&&(f in r||f.id in r)&&(nc.graph.links[s]=nc.graph.rawlinks[o],s++)}}},nc.graph.getTransformation=function(){var e=nc.graph.svg.select("g.nc-svg-content");if(e.empty())return[0,0,1];var t=e.attr("transform").split(/\(|,|\)/);return[parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[4])]},nc.graph.initSimulation=function(){nc.graph.svg=d3.select("#nc-graph-svg");var e=nc.graph.getTransformation();nc.graph.svg.selectAll("defs,g,rect").remove();var t='<circle id="nc-newnode" cx=0 cy=0 r=9></circle>',n='<style type="text/css">';n+="line.nc-link-highlight { stroke: #000000; stroke-width: 4; } ",n+="use.nc-node-highlight { stroke: #000000; stroke-width: 4; } ",n+="</style>";var r=$.map($.extend({},nc.ontology.nodes,nc.ontology.links),function(e){return[e]});nc.graph.svg.selectAll("defs").data(r).enter().append("defs").html(function(e){return e.defs}),nc.graph.svg.append("defs").html(n+t);var i=parseInt(nc.graph.svg.style("width")),s=parseInt(nc.graph.svg.style("height"));nc.graph.sim=d3.forceSimulation().force("link",d3.forceLink().distance(45).id(function(e){return e.id})).force("charge",d3.forceManyBody()).force("center",d3.forceCenter(i/2,s/2)).velocityDecay(.5);var o=d3.drag().on("start",nc.graph.panstarted).on("drag",nc.graph.panned).on("end",nc.graph.panended),u=d3.zoom().scaleExtent([.125,4]).on("zoom",nc.graph.zoom);nc.graph.svg.append("rect").classed("nc-svg-background",!0).attr("width","100%").attr("height","100%").style("fill","none").style("pointer-events","all").call(o).call(u).on("wheel",function(){d3.event.preventDefault()}).on("click",nc.graph.unselect),nc.graph.svg.append("g").classed("nc-svg-content",!0).attr("transform","translate("+e[0]+","+e[1]+")scale("+e[2]+")"),nc.graph.rawnodes.length>0&&nc.graph.simStart()},nc.graph.simStart=function(){nc.graph.svg.selectAll("g.links,g.nodes").remove(),nc.graph.sim.alpha(0),nc.graph.filterNodes(),nc.graph.filterLinks();var e=d3.drag().on("start",nc.graph.dragstarted).on("drag",nc.graph.dragged).on("end",nc.graph.dragended),t=nc.graph.svg.select("g.nc-svg-content").append("g").attr("class","links").selectAll("line").data(nc.graph.links).enter().append("line").attr("class",function(e){return"nc-default-link "+e["class"]}).attr("id",function(e){return e.id}).on("click",nc.graph.select),n=nc.graph.svg.select("g.nc-svg-content").append("g").attr("class","nodes").selectAll("use").data(nc.graph.nodes).enter().append("use").attr("xlink:href",function(e){return"#"+e["class"]}).attr("id",function(e){return e.id}).attr("class",function(e){return"nc-default-node "+e["class"]}).call(e).on("click",nc.graph.select).on("dblclick",nc.graph.unpin),r=function(){t.attr("x1",dsourcex).attr("y1",dsourcey).attr("x2",dtargetx).attr("y2",dtargety),n.attr("x",dx).attr("y",dy)};nc.graph.sim.nodes(nc.graph.nodes).on("tick",r),nc.graph.sim.force("link").links(nc.graph.links)},nc.graph.simStop=function(){nc.graph.sim.stop()},nc.graph.simUnpause=function(){nc.graph.sim.alpha(.7).restart()};var dsourcex=function(e){return e.source.x},dsourcey=function(e){return e.source.y},dtargetx=function(e){return e.target.x},dtargety=function(e){return e.target.y},dx=function(e){return e.x},dy=function(e){return e.y};nc.graph.unpin=function(e){"index"in e&&(nc.graph.nodes[e.index].fx=null,nc.graph.nodes[e.index].fy=null)},nc.graph.dragstarted=function(e){nc.graph.select(e);switch(nc.graph.mode){case"select":d3.event.active||nc.graph.sim.alphaTarget(.3).restart();break;case"newlink":nc.graph.simStop(),nc.graph.svg.select('use[id="'+e.id+'"]').classed("nc-newlink-source",!0),nc.graph.svg.select('g[class="links"]').append("line").attr("source",e.id).attr("class","nc-draggedlink").attr("x1",e.x).attr("y1",e.y).attr("x2",e.x+20).attr("y2",e.y+20);break;default:}},nc.graph.dragged=function(e){var t=d3.mouse(this);switch(nc.graph.mode){case"select":var n=e.index;nc.graph.nodes[n].fx=t[0],nc.graph.nodes[n].fy=t[1];break;case"newlink":var r=nc.graph.findNearestNode(t);nc.graph.svg.select('line[class="nc-draggedlink"]').attr("target",r.id).attr("x2",r.x).attr("y2",r.y);var i=nc.graph.svg.select("#"+r.id);i.classed("nc-newlink-target")||(nc.graph.svg.selectAll("use").classed("nc-newlink-target",!1),i.classed("nc-newlink-target",!0));break;default:}},nc.graph.dragended=function(e){var t=e.index;switch(nc.graph.mode){case"select":d3.event.active||nc.graph.sim.alphaTarget(0),nc.graph.nodes[t].fx=null,nc.graph.nodes[t].fy=null;break;case"newlink":var n=nc.graph.addLink();nc.graph.select(n);break;case"default":}},nc.graph.point=[0,0],nc.graph.panstarted=function(){var e=d3.mouse(this),t=nc.graph.svg.select("g.nc-svg-content").attr("transform").split(/\(|,|\)/);nc.graph.point=[e[0]-t[1],e[1]-t[2],t[4]]},nc.graph.panned=function(){var e=d3.mouse(this),t=e[0]-nc.graph.point[0],n=e[1]-nc.graph.point[1];nc.graph.svg.select("g.nc-svg-content").attr("transform","translate("+t+","+n+")scale("+nc.graph.point[2]+")")},nc.graph.panended=function(){},nc.graph.zoom=function(){var e=nc.graph.svg.select("g.nc-svg-content").attr("transform").split(/\(|,|\)/);e=[parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[4])];var t=e[2],n=d3.event.transform.k,r=parseInt(nc.graph.svg.style("width").replace("px",""))/2,i=parseInt(nc.graph.svg.style("height").replace("px",""))/2,s=[r+(e[0]-r)*(n/t),i+(e[1]-i)*(n/t),n];nc.graph.svg.select("g.nc-svg-content").attr("transform","translate("+s[0]+","+s[1]+")scale("+s[2]+")")},nc.graph.getCoord=function(e){var t=nc.graph.getTransformation();return[(e[0]-t[0])/t[2],(e[1]-t[1])/t[2]]},nc.graph.resetForms=function(){$("#fg-linkname,#fg-linktitle,#fg-linkclass,#fg-linksource,#fg-linktarget").removeClass("has-warning has-error has-success"),$("#fg-linkname label").html("Link name:"),$("#fg-linktitle label").html("Link title:"),$("#fg-linkclass label").html("Link class:"),$("#fg-linksource label").html("Source:"),$("#fg-linktarget label").html("Target:"),$("#fg-nodename,#fg-nodetitle,#fg-nodeclass").removeClass("has-warning has-error has-success"),$("#fg-nodename label").html("Node name"),$("#fg-nodetitle label").html("Node title"),$("#fg-nodeclass label").html("Node class")},nc.graph.findNearestNode=function(e){var t=0,n=Infinity;for(var r=0;r<nc.graph.nodes.length;r++){var i=Math.pow(nc.graph.nodes[r].x-e[0],2)+Math.pow(nc.graph.nodes[r].y-e[1],2);i<n&&(n=i,t=r)}return nc.graph.nodes[t]},nc.graph.replaceNodeId=function(e,t){var n,r=nc.graph.links.length;for(n=0;n<r;n++)nc.graph.links[n].source==e&&(nc.graph.links[n].source=t),nc.graph.links[n].target==e&&(nc.graph.links[n].target=t);var i=nc.graph.nodes.length;for(n=0;n<i;n++)if(nc.graph.nodes[n].id==e)return nc.graph.nodes[n].id=t,n;return-1},nc.graph.replaceLinkId=function(e,t){var n=nc.graph.links.length;for(var r=0;r<n;r++)if(nc.graph.links[r].id==e)return nc.graph.links[r].id=t,r;return-1},nc.graph.createNode=function(){nc.graph.resetForms();if(!nc.editor)return;if(nc.utils.checkFormInput("fg-nodename","node name",1)+nc.utils.checkFormInput("fg-nodetitle","node title",2)<2)return 0;var e=$("#nc-graph-newnode form").attr("val"),t=$("#fg-nodename input").val(),n=$("#fg-nodeclass button.dropdown-toggle").attr("selection");$("#nc-graph-newnode button.submit").removeClass("btn-success").addClass("btn-default").html("Sending...").attr("disabled",!0),$.post(nc.api,{controller:"NCGraphs",action:"createNewNode",network:nc.network,name:t,title:$("#fg-nodetitle input").val(),"abstract":t,content:t,"class":n},function(r){nc.utils.alert(r),r=JSON.parse(r);if(nc.utils.checkAPIresult(r))if(r["success"]==0||r["data"]==0)$("#fg-nodename").addClass("has-error has-feedback"),$("#fg-nodename label").html("Please choose another node name:");else if(r["success"]==1){$("#nc-graph-newnode form").attr("disabled",!0),$("#nc-graph-newnode button.submit").attr("disabled",!0);var i=nc.graph.replaceNodeId(e,r.data);nc.graph.nodes[i].name=t,nc.graph.nodes[i]["class"]=n,nc.graph.svg.select('use[id="'+e+'"]').attr("id",r.data).classed("nc-newnode",!1).classed("nc-node-highlight",!1).classed(n,!0).classed("nc-node-highlight",!0),$("#nc-graph-newnode").hide()}setTimeout(function(){$("#nc-graph-newnode form").attr("disabled",!1),$("#nc-graph-newnode button.submit").addClass("btn-success").removeClass("btn-default disabled").html("Create node").attr("disabled",!1)},nc.ui.timeout/4)})},nc.graph.createLink=function(){nc.graph.resetForms();if(!nc.editor)return;if(nc.utils.checkFormInput("fg-linkname","link name",1)+nc.utils.checkFormInput("fg-linksource","link source",1)+nc.utils.checkFormInput("fg-linktarget","link target",1)+nc.utils.checkFormInput("fg-linktitle","link title",2)<4)return 0;var e=$("#nc-graph-newlink form").attr("val"),t=$("#fg-linkname input").val(),n=$("#fg-linkclass button.dropdown-toggle").attr("selection");$("#nc-graph-newlink button.submit").removeClass("btn-success").addClass("btn-default").html("Sending...").attr("disabled",!0),$.post(nc.api,{controller:"NCGraphs",action:"createNewLink",network:nc.network,name:t,title:$("#fg-linktitle input").val(),"abstract":t,content:t,"class":n,source:$("#fg-linksource input").val(),target:$("#fg-linktarget input").val()},function(r){nc.utils.alert(r),r=JSON.parse(r);if(nc.utils.checkAPIresult(r))if(r["success"]==0||r["data"]==0)$("#fg-linkname").addClass("has-error has-feedback"),$("#fg-linkname label").html("Please choose another link name:");else if(r["success"]==1){$("#nc-graph-newlink form").attr("disabled",!0),$("#nc-graph-newlink button.submit").attr("disabled",!0);var i=nc.graph.replaceLinkId(e,r.data);nc.graph.links[i].name=t,nc.graph.links[i]["class"]=n,nc.graph.svg.select('line[id="'+e+'"]').attr("id",r.data).classed("nc-newlink",!1).classed("nc-link-highlight",!1).classed(n,!0).classed("nc-link-highlight",!0),$("#nc-graph-newlink").hide()}setTimeout(function(){$("#nc-graph-newlink form").attr("disabled",!1),$("#nc-graph-newlink button.submit").addClass("btn-success").removeClass("btn-default disabled").html("Create link").attr("disabled",!1)},nc.ui.timeout/4)})},nc.graph.removeNode=function(){nc.graph.simStop();var e=nc.graph.svg.select("use.nc-node-highlight").attr("id");nc.graph.rawnodes=nc.graph.rawnodes.filter(function(t,n,r){return t.id!=e});for(var t=0;t<nc.graph.rawlinks.length;t++)nc.graph.rawlinks[t].source=nc.graph.rawlinks[t].source.id,nc.graph.rawlinks[t].target=nc.graph.rawlinks[t].target.id;nc.graph.rawlinks=nc.graph.rawlinks.filter(function(t,n,r){return t.source!=e&&t.target!=e}),nc.graph.initSimulation(),$("#nc-graph-newnode").hide()},nc.graph.removeLink=function(){nc.graph.simStop();var e=nc.graph.svg.select("line.nc-link-highlight").attr("id");nc.graph.rawlinks=nc.graph.rawlinks.filter(function(t,n,r){return t.id!=e}),nc.graph.initSimulation(),$("#nc-graph-newlink").hide()};if(typeof nc=="undefined")throw new Error("nc is undefined");nc.ontology={},nc.ontology.nodes={},nc.ontology.links={},nc.ontology.createClass=function(e,t,n){if(nc.utils.checkString(e,1)<1){nc.msg("Hey!","Invalid class name");return}$.post(nc.api,{controller:"NCOntology",action:"createNewClass",network:nc.network,name:e,title:e,"abstract":"",content:"",parent:"",connector:+t,directional:+n},function(r){nc.utils.alert(r),r=JSON.parse(r);if(r["success"]==0)nc.msg("Error",r.errormsg);else{var i='<circle id="'+e+'" cx=0 cy=0 r=9 />';t&&(i='<style type="text/css"></style>');var s={class_id:r.data,parent_id:"",connector:+t,directional:+n,name:e,defs:i,status:1};nc.ui.addClassTreeRow(s,1)}})},nc.ontology.updateClassProperties=function(e,t,n,r,i){if(nc.utils.checkString(t,1)<1){nc.msg("Hey!","Invalid class name");return}var s=$('div.nc-classdisplay[val="'+e+'"] span[val="nc-classname"]').html(),o=n;n!=""&&(o=$('div.nc-classdisplay[val="'+n+'"] span[val="nc-classname"]').html());var u=nc.utils.sanitize($('form[val="'+e+'"] textarea').val(),!0);$.post(nc.api,{controller:"NCOntology",action:"updateClass",network:nc.network,target:s,name:t,title:"","abstract":"",content:"",defs:u,status:1,parent:o,connector:+r,directional:+i},function(n){nc.utils.alert(n),n=JSON.parse(n);if(n["success"]==0)nc.msg("Error",n.errormsg);else{var r=$('div.nc-classdisplay[val="'+e+'"]');r.find('> span.nc-comment[val="nc-classname"]').html(t);var s=i?" (directional)":"";r.find('> span.nc-comment[val="nc-directional"]').html(s)}})},nc.ontology.askConfirmation=function(e,t){var n=$('li[val="'+e+'"] span[val="nc-classname"]').html(),r=$("#nc-deprecateconfirm-modal");r.find("#nc-deprecateconfirm-action").html(t),r.find("#nc-deprecateconfirm-class").html(n).attr("val",e),t=="inactive"?($('#nc-deprecateconfirm-modal button[val="nc-confirm"]').off("click").on("click",nc.ontology.confirmDeprecate),r.find('p[val="deprecate"]').show(),r.find('p[val="activate"]').hide()):($('#nc-deprecateconfirm-modal button[val="nc-confirm"]').off("click").on("click",nc.ontology.confirmActivate),r.find('p[val="deprecate"]').hide(),r.find('p[val="activate"]').show()),r.modal("show")},nc.ontology.confirmActivate=function(){var e=$("#nc-deprecateconfirm-modal #nc-deprecateconfirm-class"),t=e.attr("val"),n=e.html();$.post(nc.api,{controller:"NCOntology",action:"activateClass",network:nc.network,name:n},function(e){nc.utils.alert(e),e=JSON.parse(e),e["success"]==0?nc.msg("Error",e.errormsg):e["data"]==1?nc.ui.toggleClassDisplay($('li[val="'+t+'"]')):nc.msg("That's strange",e.data)})},nc.ontology.confirmDeprecate=function(){var e=$("#nc-deprecateconfirm-modal #nc-deprecateconfirm-class"),t=e.attr("val"),n=e.html();$.post(nc.api,{controller:"NCOntology",action:"removeClass",network:nc.network,name:n},function(e){nc.utils.alert(e),e=JSON.parse(e);if(e["success"]==0)nc.msg("Error",e.errormsg);else{var n=$('li[val="'+t+'"]');e["data"]==1?n.fadeOut(nc.ui.speed,function(){$(this).remove()}):nc.ui.toggleClassDisplay(n)}})},nc.ontology.addLongnames=function(e){var t=$('<div><div val="" text=""></div></div>'),n=0,r=Object.keys(e).length;while(n<r)n=0,$.each(e,function(r,i){var s=i.class_id,o=i.name,u=i.parent_id,a=o;if(t.find('div[val="'+s+'"]').length==1)n++;else{var f=t.find('div[val="'+u+'"]');f.length==1&&(u!=""&&(a=f.attr("text")+":"+o),f.append('<div val="'+s+'" text="'+a+'"></div>'),e[s].longname=a,n++)}});return e};if(typeof nc=="undefined")throw new Error("nc is undefined");nc.sandbox={},nc.sandbox.generateMarkdown=function(){var e=$("#nc-sandbox-required"),t=$("#nc-sandbox-optional"),n={},r=function(){var e=$(this).attr("val"),t=$(this).find("input"),r="";if(t.length==1)r=t.val(),n[e]=isNaN(r)||r==""?r:+r;else if(t.length>1)n[e]=[],t.each(function(){var t=$(this).val();t=isNaN(t)||t==""?t:+t,n[e].push(t)});else{var i=$(this).find("textarea").val();if(i!=""){var s=i.split("\n"),o=$(this).attr("colnames").split(" ");n[e]=[];for(var u=0;u<s.length;u++){s[u]==""&&(s[u]=" 	");var a={};s[u]=s[u].split("	");for(var f=0;f<s[u].length;f++)r=s[u][f],r=isNaN(r)||r==""||r==" "?r:+r,a[o[f]]=r;n[e].push(a)}}}};e.find(".form-group").each(r),t.find(".form-group").each(r);var i="```mdalive "+e.attr("val")+"\n";i+=JSON.stringify(n,null,2)+"\n",i+="```",$("#nc-sandbox-md").val(i).change()},$(document).ready(function(){var e=$("#nc-sandbox-preview");if(e.length<=0)return;var t=$("#nc-sandbox-md");$("#nc-sandbox-md").on("change keyup paste input",function(){var n=t.val();e.html(nc.utils.md2html(n))});var n=$("#nc-sandbox-optional").hide();$(".nc-sandbox-optional").css("cursor","pointer").click(function(){n.toggle(),$(this).find("span").toggleClass("dropup")}),$("textarea").on("keyup",function(e){if(e.keyCode==32){var t=$(this).val(),n=$(this).prop("selectionStart");t.substr(n-2,2)=="  "&&($(this).val(t.substr(0,n-2)+"	"+t.substr(n)),$(this).prop("selectionStart",n-1).prop("selectionEnd",n-1))}}),$(".form-group input, .form-group textarea").on("keyup paste input",nc.sandbox.generateMarkdown)});if(typeof nc=="undefined")throw new Error("nc is undefined");nc.ui={},nc.ui.speed=500,nc.ui.fast=200,nc.ui.timeout=2e3,nc.ui.PermissionsWidget=function(e){function t(e,t,n){var r=["None","View","Comment","Edit","Curate"],i=r[e];n=n==e?" active":"",t=="guest"&&e>1&&(n=" disabled");var s='<label class="btn btn-default btn-sm nc-mw-sm'+n+'">';return s+='<input type="radio" autocomplete="off" value="'+e+'" '+n+">",s+=i+"</label>",s}var n=$("<div></div>");return $.each(e,function(e,r){var i=r.user_id,s=r.permissions,o=i;i!="guest"&&(o+=" ("+r.user_firstname+" "+r.user_middlename+" "+r.user_lastname+")");var u='<form class="form-inline nc-form-permissions" val="'+i+'" onsubmit="return false;">';u+='<div class="form-group" style="width:100%">',u+='<label class="col-form-label nc-fg-name">'+o+"</label>",u+='<span><div class="btn-group" data-toggle="buttons">'
;for(var a=0;a<5;a++)u+=t(a,i,s);u+="</div>",u+='<button class="btn btn-success btn-sm" val="'+i+'">Update</button></span>',u+="</div></form>",u=$(u),u.find("button").click(function(){nc.users.updatePermissions(i)}),n.append(u)}),n},nc.ui.ClassTreeWidget=function(e,t){var n=t?$("#nc-ontology-links"):$("#nc-ontology-nodes"),r={parent_id:"",class_id:"",name:"",connector:+t,directional:0},i='<ol class="nc-classtree-children nc-classtree-root" val=""></ol>';i+=nc.ui.ClassForm(r),n.append(i);var s;n.find(".nc-classtree-children").sortable({handle:"svg",afterMove:function(e,t){s!=t&&(s&&s.el.removeClass("droptarget"),t.el.addClass("droptarget"),s=t)},onDrop:function(e,t,n){t.el.removeClass("droptarget"),n(e,t),e.addClass("aftermove"),setTimeout(function(){e.removeClass("aftermove")},nc.ui.timeout/2)}});do{var o=0;$.each(e,function(e,t){o+=nc.ui.addClassTreeRow(t)})}while(o<Object.keys(e).length);n.on("click",'span[val="nc-classname"]',function(){var e=$(this).parent().attr("val");window.location.replace("?network="+nc.network+"&object="+e)}),n.on("submit","form.nc-classcreate",function(){var e=$(this).find("input").val(),n=+$(this).find("input.form-check-input").is(":checked");nc.ontology.createClass(e,t,n)}),n.on("click","div.nc-classdisplay button[val='edit']",function(){var e=$(this).parent().attr("val"),t=$(this).parent().find('span.nc-comment[val="nc-classname"]').html(),r=n.find("form.nc-classupdate[val='"+e+"']");r.find("input").val(t),r.toggle(),n.find("div.nc-classdisplay[val='"+e+"']").toggle(),n.find("div.nc-style").show(nc.ui.fast)}),n.on("click","div.nc-classdisplay button[val='remove']",function(){var e=$(this).parent().attr("val");nc.ontology.askConfirmation(e,"inactive")}),n.on("click","div.nc-classdisplay button[val='activate']",function(){var e=$(this).parent().attr("val");nc.ontology.askConfirmation(e,"active")}),n.on("click","form.nc-classupdate .nc-btn-class-cancel",function(){var e=$(this).attr("val");n.find("div.nc-style").hide(nc.ui.fast),setTimeout(function(){n.find("div.nc-classdisplay[val='"+e+"']").toggle(),n.find("form.nc-classupdate[val='"+e+"']").toggle()},nc.ui.fast)}),n.on("click","form.nc-classupdate .nc-btn-class-update",function(){var e=$(this).parent().parent(),t=e.attr("val"),r=e.parent().parent().attr("val"),i=e.find("input").val(),s=e.find("input.form-check-input").length>0,o=0+e.find("input.form-check-input").is(":checked");nc.ontology.updateClassProperties(t,i,r,s,o),n.find("div.nc-classdisplay[val='"+t+"']").toggle(),n.find("form.nc-classupdate[val='"+t+"']").toggle()}),n.on("change keyup","textarea",function(){var e=nc.utils.sanitize($(this).val(),!0),t=$(this).parent().parent().parent(),n=t.attr("val");try{t.find('svg[val="'+n+'"] defs').empty().append($(e)),t.find('svg[val="'+n+'"]').DOMRefresh()}catch(r){}}),n.find("div.nc-classdisplay").show(),n.find("form.nc-classcreate[val='']").show()},nc.ui.ClassTreeRowWidget=function(e){var t=nc.ui.ClassDisplay(e),n=nc.ui.ClassForm(e),r=e.class_id,i=e.name,s='<ol class="nc-classtree-children" val="'+e.class_id+'"></ol>',o='<svg class="nc-symbol" val="'+r+'"><defs></defs>';o+='<g transform="translate(18,18)">',e["connector"]==1?o+='<line class="nc-default-link '+i+'" x1=-17 x2=17 y1=0 y2=0/>':o+='<use xlink:href="#'+i+'" class="nc-default-node '+i+'"/>',o+="</g></svg>";var u=$('<li val="'+e.class_id+'">'+o+t+n+s+"</li>");return e["status"]!=1&&(u=nc.ui.toggleClassDisplay(u)),u},nc.ui.toggleClassDisplay=function(e){return e.find("> div.nc-classdisplay, > svg").toggleClass("nc-deprecated").find('button,span.nc-comment[val="nc-deprecated"]').toggle(),e},nc.ui.ClassDisplay=function(e){var t='<div val="'+e.class_id+'" class="nc-classdisplay">';t+='<span class="nc-comment" val="nc-classname">'+e.name+"</span>",t+='<span class="nc-comment" val="nc-directional">',+e.directional&&(t+=" (directional)"),t+='</span><span class="nc-comment" val="nc-deprecated" style="display: none">[inactive]</span>';if(nc.curator){var n='<button class="pull-right btn btn-primary btn-sm nc-mw-sm nc-hm-3" ';t+=n+' val="remove">Remove</button>',t+=n+' val="activate" style="display: none">Activate</button>',t+=n+' val="edit">Edit</button>'}return t+="</div>",t},nc.ui.ClassForm=function(e){if(!nc.curator)return"";var t=e.class_id,n=e.name,r=e.defs,i=+e.connector,s=+e.directional,o=n==""?"nc-classcreate":"nc-classupdate",u='<form val="'+t+'" style="display: none" class="form-inline nc-class-form '+o+'" onsubmit="return false">',a='<div class="form-group"><input class="form-control input-sm" placeholder="Class name"';n!=""&&(a+=' val="'+n+'"'),a+="></div>",i&&(a+='<div class="form-group"><label class="form-check-inline"><input type="checkbox" class="form-check-input"',s&&(a+=" checked"),a+=">Directional</label></div>"),n==""?(a+='<div class="form-group"><button class="btn btn-success btn-sm submit">',a+="Create new class</button></div>"):(a+='<div class="form-group">',a+='<button val="'+t+'" class="btn btn-primary btn-sm nc-btn-class-update">Update</button>',a+='<button val="'+t+'" class="btn btn-primary btn-sm nc-btn-class-cancel">Cancel</button>',a+="</div><br/>",a+='<div class="form-group nc-style"><textarea class="form-control" rows=4>'+r+"</textarea></div>");var f="</div></form>";return u+a+f},nc.ui.addClassTreeRow=function(e){var t=+e.connector?$("#nc-ontology-links"):$("#nc-ontology-nodes");if(t.find('li[val="'+e.class_id+'"]').length>0)return!0;var n=e.parent_id,r=t.find('ol.nc-classtree-children[val="'+n+'"]');if(r.length==0)return!1;var i=$(nc.ui.ClassTreeRowWidget(e)).hide();return r.children("form.nc-classcreate").length>0?$(i).insertBefore(r.children("form.nc-classcreate")):r.append(i),r.find("li").show(nc.ui.speed),r.find("div.nc-classdisplay").show(nc.ui.speed),setTimeout(function(){r.find("textarea").keyup()},nc.ui.speed),!0},nc.ui.ActivityLogToolbar=function(e,t){var n='<ul class="pagination">',r=e/t;for(var i=0;i<r;i++)n+="<li value="+i+'><a href="javascript:nc.loadActivity('+i+", "+t+')">'+(i+1)+"</a></li>";return n+='</ul><div id="nc-log-contents"></div>',n},nc.ui.populateActivityArea=function(e){var t="";$.each(e,function(e,n){t+=nc.ui.OneLogEntry(n)}),$("#nc-log-contents").html(t)},nc.ui.OneLogEntry=function(e){var t='<div class="media nc-log-entry">';return t+='<span class="nc-log-entry-date">'+e.datetime+" </span>",t+='<span class="nc-log-entry-user">'+e.user_id+" </span>",t+='<span class="nc-log-entry-action">'+e.action+" </span>",t+='<span class="nc-log-entry-target">'+e.target_name+" </span>",e.value.length>0&&(t+='<span class="nc-log-entry-value">('+e.value+")</span>"),t+="</div>",t},nc.ui.ButtonGroup=function(e){var t='<div class="btn-group nc-toolbar-group nc-toolbar-group-new" role="group">';for(var n in e)t+='<button class="btn btn-primary" val="'+e[n]+'">'+e[n]+"</button>";return t+="</div>",$(t)},nc.ui.DropdownButton=function(e,t,n,r){var i='<span class="pull-right caret nc-dropdown-caret"></span>',s='<div class="btn-group nc-toolbar-group nc-toolbar-group-new" role="group">';s+='<div class="btn-group" role="group">',s+='<button class="btn btn-primary dropdown-toggle" val="'+n+'" class_name="" data-toggle="dropdown"><span class="pull-left nc-classname-span">'+e+" "+"</span>"+i+"</button>",s+='<ul class="dropdown-menu">';for(var o in t){var u=!0,a="";t[o].status!=1&&(r?a=' class="nc-deprecated"':u=!1),u&&(s+="<li"+a+'><a class_id="'+t[o].id+'" class_name="'+t[o].val+'" href="#">'+t[o].label+"</a></li>")}s+="</ul>",s+="</div></div>";var f=$(s);return f.find("a").click(function(){var t=$(this).attr("class_id"),n=$(this).attr("class_name"),r=$(this).parent().parent().parent().parent();return r.find("button.dropdown-toggle").html('<span class="pull-left nc-classname-span">'+e+" "+n+"</span>"+i).addClass("active").attr("class_name",n).attr("class_id",t),$(this).dropdown("toggle"),!1}),f},nc.ui.AnnoEditBox=function(){var e='<div class="nc-curation-box">';e+='<div class="nc-curation-toolbox" style="display: none">',e+='<a role="button" class="nc-curation-toolbox-md btn btn-sm btn-default nc-mw-sm" style="display: none">Edit</a>',e+='<a role="button" class="nc-curation-toolbox-preview btn btn-sm btn-default nc-mw-sm">Preview</a>',e+='<a role="button" class="nc-curation-toolbox-close pull-right">close</a>',e+='</div><div class="nc-curation-content"></div>',e+='<textarea class="nc-curation-content" style="display: none"></textarea>',e+='<a role="button" class="btn btn-sm btn-success nc-submit nc-mw-sm" style="display: none">Submit</a>',e+='<a role="button" class="btn btn-sm btn-danger nc-remove nc-mw-sm" style="display: none">Remove</a></div>';var t=$(e);return t.find("a.nc-curation-toolbox-md").click(function(){var e=$(this).parent().parent(),t=6+parseInt(e.find("div.nc-curation-content").css("height").replace("px",""));e.find("div.nc-curation-content").hide(),e.find("textarea").css("height",t).show(),e.find("a.nc-submit").show(),e.find("a.nc-curation-toolbox-preview").show(),e.find("a.nc-curation-toolbox-md").hide()}),t.find("a.nc-curation-toolbox-preview").click(function(){var e=$(this).parent().parent(),t=6+parseInt(e.find("textarea").css("height").replace("px","")),n=e.find("textarea").hide().val(),r=nc.utils.md2html(n);e.find("div.nc-curation-content").css("min-height",t).html(r).show(),e.find("a.nc-curation-toolbox-preview,a.nc-curation-toolbox-md").toggle()}),t.find("a.nc-submit").click(function(){var e=$(this).parent(),t=e.find("textarea").val(),n=e.parent().attr("val");nc.updateAnnotationText(n,t),e.find("a.nc-curation-toolbox-close").click()}),t.find("a.nc-curation-toolbox-close").click(function(){var e=$(this).parent().parent();e.find("a.nc-submit").hide(),e.find("div.nc-curation-toolbox").hide(),e.find("textarea").css("height",""),e.find("a.nc-curation-toolbox-preview").click()}),t.find(".nc-curation-content").on("click",function(){var e=$(this).parent();if(!nc.curator&&e.parent().attr("owner")!=nc.userid)return;e.parent().hasClass("nc-editable-text-visible")&&!e.find(".nc-curation-toolbox").is(":visible")&&(e.find("a.nc-curation-toolbox-md").click(),e.find(".nc-curation-toolbox").show())}),t},nc.ui.CommentBox=function(e,t,n,r,i){var s="nc-comment-response";t==n&&(s="nc-comment-primary");var o='<div class="media" val="'+r+'">';o+='<a class="media-left">',o+='<img class="media-object '+s+'" src="nc-data/users/'+e+'.png"></a>',o+='<div class="media-body" val="'+r+'"></div></div>';var u=$(o),a=u.find(".media-body");i==""&&a.append('<div class="nc-mb-10"><span class="nc-log-entry-user">Write a new comment</span></div>'),a.append(nc.ui.AnnoEditBox()),i==""&&(a.find(".nc-curation-toolbox,textarea").show(),a.find(".nc-curation-toolbox-close").hide(),a.find("a.nc-submit").off("click").show().click(function(){var e=$(this).parent().find("textarea").val();nc.createComment(e,t,n)}));if(t==n&&i!=""){var f='<a val="'+r+'" class="nc-comment-response">Respond to the comment</a>';f=$(f),f.click(function(){var e=nc.ui.CommentBox(nc.userid,t,r,"","");$(this).hide().parent().append(e),e.find("a.nc-save").off("click").show().click(function(){var e=$(this).parent().find("textarea").val();nc.createComment(e,t,r)})}),a.append(f)}return t!=n&&i==""&&a.find(".nc-curation-toolbox-close").show().off("click").on("click",function(){a.parent().parent().find("a.nc-comment-response").show(),a.parent().remove()}),u},nc.ui.addCommentBox=function(e){var t=$("#nc-comments"),n='<div class="nc-mb-5 nc-comment-head"><span class="nc-comment-date">'+e.datetime+"</span>";n+='<span class="nc-comment-user">'+e.owner_id+"</span>",e.modified!=null&&(n+='<span class="nc-comment-date"> (edited '+e.modified+' by <span class="nc-comment-user">'+e.user_id+"</span>)</span>"),n+="</div>";var r=nc.ui.CommentBox(e.owner_id,e.root_id,e.parent_id,e.anno_id,e.anno_text);r.find("textarea").html(e.anno_text),r.find(".media-body a.nc-curation-toolbox-preview").click(),r.find("div.nc-curation-content").css("min-height",0),r.find(".media-body").prepend(n).addClass("nc-editable-text").attr("val",e.anno_id).attr("owner",e.owner_id),e.root_id==e.parent_id?t.append(r):r.insertBefore($('.media-body a[val="'+e.parent_id+'"]')),e.datetime=="just now"&&r.hide().show(nc.ui.speed)},nc.ui.populateCommentsBox=function(e){var t=$("#nc-comments").attr("val");$.each(e,function(e,n){var r=n;r.root_id=t,nc.ui.addCommentBox(n)})};if(typeof nc=="undefined")throw new Error("nc is undefined");nc.users={},nc.users.sendLogin=function(e,t,n){return $("#"+e+",#"+t).removeClass("has-warning has-error"),nc.utils.checkFormInput(e,"user id",1)+nc.utils.checkFormInput(t,"password",3)<2?0:($.post(nc.api,{controller:"NCUsers",action:"verify",target_id:$("#"+e+" input").val(),target_password:$("#"+t+" input").val(),remember:$("#"+n+" input").is(":checked")},function(e){nc.utils.alert(e),e=JSON.parse(e),nc.utils.checkAPIresult(e)&&(e["success"]==0?($("#fg-userid,#fg-password").addClass("has-error has-feedback"),$("#fg-userid label").html("Please verify the user id is correct:"),$("#fg-password label").html("Please verify the password is correct:")):window.location.replace("?page=front"))}),0)},nc.users.sendLogout=function(){window.location.replace("?page=logout")},nc.users.lookup=function(){var e=$("#nc-form-permissions input").val();if(nc.utils.checkString(e,1)==0)return nc.msg("Hey!","Invalid user id"),!1;var t=$("#nc-permissions-lookup");return t.removeClass("btn-success").addClass("btn-warning disabled").html("Checking"),$.post(nc.api,{controller:"NCUsers",action:"queryPermissions",network:nc.network,target:e},function(n){nc.utils.alert(n),n=JSON.parse(n),t.html("Lookup").removeClass("btn-warning disabled").addClass("btn-success"),nc.utils.checkAPIresult(n)&&(n["success"]==0?nc.msg("Error",n.errormsg):n["data"]==0?($("#nc-grantconfirm-user").html(e),$("#nc-grantconfirm-network").html(nc.network),$("#nc-grantconfirm-modal").modal("show")):nc.msg("Response","User already has permissions"))}),!1},nc.users.updatePermissions=function(e){var t=$('form.nc-form-permissions[val="'+e+'"]'),n=t.find("label.active").find("input:radio").val(),r=t.find("button");r.addClass("btn-warning disabled").html("Updating"),nc.users.updatePermissionsGeneric(e,n,function(t){nc.utils.alert(t),t=JSON.parse(t),r.removeClass("btn-warning btn-success").html("Done").addClass("btn-default"),setTimeout(function(){r.html("Update").removeClass("btn-default disabled").addClass("btn-success")},nc.ui.timeout);if(nc.utils.checkAPIresult(t)&&t["success"]==0){nc.msg("Error",t.errormsg);return}n==0&&e!=="guest"&&$('.nc-form-permissions[val="'+e+'"]').fadeOut(nc.ui.speed,function(){$(this).remove()})})},nc.users.grantView=function(){var e=$("#nc-form-permissions input").val();return nc.users.updatePermissionsGeneric(e,1,function(t){nc.utils.alert(t),t=JSON.parse(t),$("#nc-form-permissions input").val("");var n=$(nc.ui.PermissionsWidget(t.data)).hide();$("#nc-permissions-users").append(n),n.show(nc.ui.speed)}),!1},nc.users.updatePermissionsGeneric=function(e,t,n){$.post(nc.api,{controller:"NCUsers",action:"updatePermissions",network_name:nc.network,target_id:e,permissions:t},n)};